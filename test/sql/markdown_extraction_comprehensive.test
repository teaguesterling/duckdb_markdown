# name: test/sql/markdown_extraction_comprehensive.test
# description: Clean comprehensive test suite for markdown extraction functions
# group: [sql]

require markdown

#===================================================================
# Test 1: Basic Function Existence and Signatures
#===================================================================

# Test all extraction functions exist
statement ok
SELECT md_extract_code_blocks('');

statement ok  
SELECT md_extract_links('');

statement ok
SELECT md_extract_images('');

statement ok
SELECT md_extract_table_rows('');

statement ok
SELECT md_extract_tables_json('');

#===================================================================
# Test 2: Parameter Validation and Error Handling
#===================================================================

# Test NULL input handling
query I
SELECT md_extract_code_blocks(NULL) IS NULL;
----
true

query I
SELECT md_extract_links(NULL) IS NULL;
----
true

# Test empty string input
query I
SELECT len(md_extract_code_blocks(''));
----
0

query I
SELECT len(md_extract_links(''));
----
0

# Test invalid parameter types - should fail
statement error
SELECT md_extract_code_blocks(123);
----
Binder Error

statement error
SELECT md_extract_links(123);
----
Binder Error

# Test too many parameters - should fail
statement error
SELECT md_extract_code_blocks('test', 'extra');
----
Binder Error

statement error
SELECT md_extract_links('test', 'extra');
----
Binder Error

#===================================================================
# Test 3: Code Block Extraction
#===================================================================

# Test single code block
query I
SELECT len(md_extract_code_blocks(E'```python\nprint("hello")\n```'));
----
1

# Test multiple code blocks
query I
SELECT len(md_extract_code_blocks(E'```python\ncode1\n```\n\n```sql\ncode2\n```'));
----
2

# Test code block structure - avoid multiline content issues
query II
SELECT 
  cb.language,
  cb.line_number
FROM (
  SELECT UNNEST(md_extract_code_blocks(E'```python\nprint("hello")\n```')) as cb
);
----
python	1

# Test code content with newline replacement (our solution!)
query I
SELECT replace(cb.code, chr(10), '\\n') as code_escaped
FROM (
  SELECT UNNEST(md_extract_code_blocks(E'```python\nprint("hello")\n```')) as cb
);
----
print("hello")\\n

# Test code block with no language
query I
SELECT cb.language
FROM (
  SELECT UNNEST(md_extract_code_blocks(E'```\nplain code\n```')) as cb
);
----
(empty)

#===================================================================
# Test 4: Link Extraction
#===================================================================

# Test simple link
query IIII
SELECT 
  link.text,
  link.url,
  link.title,
  link.is_reference
FROM (
  SELECT UNNEST(md_extract_links('[GitHub](https://github.com)')) as link
);
----
GitHub	https://github.com	NULL	false

# Test link with title
query III
SELECT 
  link.text,
  link.url,
  link.title
FROM (
  SELECT UNNEST(md_extract_links('[GitHub](https://github.com "Git Repository")')) as link
);
----
GitHub	https://github.com	Git Repository

# Test multiple links
query I
SELECT len(md_extract_links('[Link1](http://example.com) and [Link2](http://test.com)'));
----
2

# Test empty link text
query I
SELECT len(md_extract_links('[](http://example.com)'));
----
1

#===================================================================
# Test 5: Image Extraction
#===================================================================

# Test simple image
query III
SELECT 
  img.alt_text,
  img.url,
  img.title
FROM (
  SELECT UNNEST(md_extract_images('![Alt text](image.jpg)')) as img
);
----
Alt text	image.jpg	NULL

# Test image with title
query III
SELECT 
  img.alt_text,
  img.url,
  img.title
FROM (
  SELECT UNNEST(md_extract_images('![Photo](photo.jpg "My Photo")')) as img
);
----
Photo	photo.jpg	My Photo

# Test multiple images
query I
SELECT len(md_extract_images('![Image1](img1.jpg) and ![Image2](img2.png)'));
----
2

#===================================================================
# Test 6: Table Extraction
#===================================================================

# Test simple table
query I
SELECT len(md_extract_table_rows(E'| Name | Age |\n|------|-----|\n| John | 25  |'));
----
4

# Test table structure - headers
query I
SELECT count(*) 
FROM (
  SELECT UNNEST(md_extract_table_rows(E'| Name | Age |\n|------|-----|\n| John | 25  |')) as row
)
WHERE row.row_type = 'header';
----
2

# Test table structure - data
query I
SELECT count(*) 
FROM (
  SELECT UNNEST(md_extract_table_rows(E'| Name | Age |\n|------|-----|\n| John | 25  |')) as row
)
WHERE row.row_type = 'data';
----
2

#===================================================================
# Test 7: Edge Cases and Composition
#===================================================================

# Test mixed content
query III
SELECT 
  len(md_extract_code_blocks(content)) > 0 as has_code,
  len(md_extract_links(content)) > 0 as has_links,
  len(md_extract_images(content)) > 0 as has_images
FROM (SELECT E'# Mixed\n[link](http://example.com) ![image](img.jpg)\n```python\ncode\n```' as content);
----
true	true	true

# Test aggregation across multiple pieces of content
query II
SELECT 
  sum(len(md_extract_code_blocks(content))) as total_code_blocks,
  sum(len(md_extract_links(content))) as total_links
FROM (VALUES 
  (E'```python\nprint("test")\n```'),
  ('[Link](http://example.com)'),
  (E'```sql\nSELECT 1;\n```\n[Another link](http://test.com)')
) as docs(content);
----
2	2

# Test filtering based on extraction results
query I
SELECT count(*)
FROM (VALUES 
  (E'```python\nprint("test")\n```'),
  ('No code here'),
  (E'```sql\nSELECT 1;\n```')
) as docs(content)
WHERE len(md_extract_code_blocks(content)) > 0;
----
2

#===================================================================
# Test 8: Performance and Memory
#===================================================================

# Test empty results don't cause issues
query IIII
SELECT 
  md_extract_code_blocks('') IS NOT NULL as code_ok,
  md_extract_links('') IS NOT NULL as links_ok,
  md_extract_images('') IS NOT NULL as images_ok,
  md_extract_table_rows('') IS NOT NULL as tables_ok;
----
true	true	true	true

# Test repeated calls
query I
SELECT count(*)
FROM generate_series(1, 10) as i
CROSS JOIN (
  SELECT UNNEST(md_extract_code_blocks(E'```python\nprint("test")\n```')) as blocks
);
----
10

#===================================================================
# Test 9: NULL Value Handling in Optional Fields
#===================================================================

# Test links: first without title, second with title
# (Regression test for NULL type inference bug)
query II
SELECT link.text, link.title
FROM (
  SELECT UNNEST(md_extract_links('[A](http://a.com) [B](http://b.com "title")')) as link
);
----
A	NULL
B	title

# Test links: first with title, second without title
query II
SELECT link.text, link.title
FROM (
  SELECT UNNEST(md_extract_links('[A](http://a.com "first title") [B](http://b.com)')) as link
);
----
A	first title
B	NULL

# Test links: all without titles
query II
SELECT link.text, link.title
FROM (
  SELECT UNNEST(md_extract_links('[A](http://a.com) [B](http://b.com) [C](http://c.com)')) as link
);
----
A	NULL
B	NULL
C	NULL

# Test links: all with titles
query II
SELECT link.text, link.title
FROM (
  SELECT UNNEST(md_extract_links('[A](http://a.com "t1") [B](http://b.com "t2") [C](http://c.com "t3")')) as link
);
----
A	t1
B	t2
C	t3

# Test images: first without title, second with title
# (Same regression test pattern for images)
query II
SELECT img.alt_text, img.title
FROM (
  SELECT UNNEST(md_extract_images('![A](a.png) ![B](b.png "image title")')) as img
);
----
A	NULL
B	image title

# Test images: first with title, second without title
query II
SELECT img.alt_text, img.title
FROM (
  SELECT UNNEST(md_extract_images('![A](a.png "first") ![B](b.png)')) as img
);
----
A	first
B	NULL

# Test images: all without titles
query II
SELECT img.alt_text, img.title
FROM (
  SELECT UNNEST(md_extract_images('![A](a.png) ![B](b.png) ![C](c.png)')) as img
);
----
A	NULL
B	NULL
C	NULL

# Test mixed NULL patterns don't affect other fields
query IIII
SELECT link.text, link.url, link.title, link.is_reference
FROM (
  SELECT UNNEST(md_extract_links('[No title](http://a.com) [Has title](http://b.com "the title")')) as link
);
----
No title	http://a.com	NULL	false
Has title	http://b.com	the title	false

#===================================================================
# Test 10: Code Block Edge Cases
#===================================================================

# Test code block with empty info string
query II
SELECT cb.language, cb.info_string
FROM (
  SELECT UNNEST(md_extract_code_blocks(E'```\ncode\n```')) as cb
);
----
(empty)	(empty)

# Test code block with language and extra info
query II
SELECT cb.language, cb.info_string
FROM (
  SELECT UNNEST(md_extract_code_blocks(E'```python extra info\ncode\n```')) as cb
);
----
python	python extra info

# Test multiple code blocks with different languages
query I
SELECT len(md_extract_code_blocks(E'```js\na\n```\n\n```py\nb\n```'));
----
2

#===================================================================
# Test 11: Table Extraction Edge Cases
#===================================================================

# Test simple table row count (2 headers + 2 data cells = 4)
query I
SELECT len(md_extract_table_rows(E'| A | B |\n|---|---|\n| 1 | 2 |'));
----
4

# Test table with empty cells - should still parse headers
query I
SELECT count(*) FROM (
  SELECT UNNEST(md_extract_table_rows(E'| A | B |\n|---|---|\n|  |  |')) as row
) WHERE row.row_type = 'header';
----
2

# Test multiple tables in document
query I
SELECT len(md_extract_table_rows(E'| A |\n|---|\n| 1 |\n\nParagraph\n\n| B |\n|---|\n| 2 |'));
----
4

#===================================================================
# Test 12: Section Extraction Edge Cases
#===================================================================

# Test nested sections
query I
SELECT len(md_extract_sections(E'# H1\nContent\n## H2\nMore\n### H3\nDeep'));
----
3

# Test section with empty content
query II
SELECT s.title, length(s.content) > 0 as has_content
FROM (
  SELECT UNNEST(md_extract_sections(E'# Empty Section\n\n# Has Content\nSome text')) as s
);
----
Empty Section	false
Has Content	true

# Test section level filtering
query I
SELECT len(md_extract_sections(E'# H1\n## H2\n### H3', 2, 2));
----
1

#===================================================================
# Test 13: md_extract_tables_json Edge Cases
#===================================================================

# Test empty input
query I
SELECT len(md_extract_tables_json(''));
----
0

# Test no tables in content
query I
SELECT len(md_extract_tables_json('Just text, no tables'));
----
0

# Test basic table structure
query IIII
SELECT t.table_index, t.num_columns, t.num_rows, t.headers
FROM (
  SELECT UNNEST(md_extract_tables_json(E'| A | B |\n|---|---|\n| 1 | 2 |')) as t
);
----
0	2	1	[A, B]

# Test table data extraction
query I
SELECT t.table_data
FROM (
  SELECT UNNEST(md_extract_tables_json(E'| A | B |\n|---|---|\n| 1 | 2 |\n| 3 | 4 |')) as t
);
----
[[1, 2], [3, 4]]

# Test multiple tables
query I
SELECT len(md_extract_tables_json(E'| A |\n|---|\n| 1 |\n\nText\n\n| B |\n|---|\n| 2 |'));
----
2

#===================================================================
# Test 14: md_section_breadcrumb
#===================================================================

# Test deep section breadcrumb
query I
SELECT md_section_breadcrumb(E'# Top\n\n## Middle\n\n### Deep', 'deep');
----
Top > Middle > Deep

# Test middle section breadcrumb
query I
SELECT md_section_breadcrumb(E'# Top\n\n## Middle\n\n### Deep', 'middle');
----
Top > Middle

# Test top-level section breadcrumb
query I
SELECT md_section_breadcrumb(E'# Top\n\n## Middle\n\n### Deep', 'top');
----
Top

# Test section not found returns empty
query I
SELECT md_section_breadcrumb(E'# Top\n\n## Middle', 'notfound');
----
(empty)

# Test empty content returns empty
query I
SELECT md_section_breadcrumb('', 'test');
----
(empty)

# Test complex hierarchy
query I
SELECT md_section_breadcrumb(E'# Root\n\n## Branch A\n\n### Leaf A1\n\n## Branch B\n\n### Leaf B1', 'leaf-a1');
----
Root > Branch A > Leaf A1

#===================================================================
# Test 15: Reference Link Detection
#===================================================================

# Test inline link is not marked as reference
query II
SELECT link.text, link.is_reference
FROM (SELECT UNNEST(md_extract_links('[Inline](http://example.com)')) as link);
----
Inline	false

# Test reference link is detected
query II
SELECT link.text, link.is_reference
FROM (SELECT UNNEST(md_extract_links(E'[Reference][ref]\n\n[ref]: http://reference.com')) as link);
----
Reference	true

# Test mixed inline and reference links
query II
SELECT link.text, link.is_reference
FROM (SELECT UNNEST(md_extract_links(E'[Inline](http://inline.com) and [Reference][id]\n\n[id]: http://ref.com')) as link);
----
Inline	false
Reference	true

# Test shortcut reference link (link text = reference id)
query II
SELECT link.text, link.is_reference
FROM (SELECT UNNEST(md_extract_links(E'[Google]\n\n[Google]: http://google.com')) as link);
----
Google	true

# Test angle bracket URL in reference definition
query II
SELECT link.text, link.is_reference
FROM (SELECT UNNEST(md_extract_links(E'[Link][ref]\n\n[ref]: <http://example.com>')) as link);
----
Link	true