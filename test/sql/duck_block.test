# name: test/sql/duck_block.test
# description: Test duck_block conversion functions
# group: [sql]

require markdown

# =============================================================================
# Test: duck_block_to_md - Single block conversion
# =============================================================================

# Heading
query I
SELECT duck_block_to_md({block_type: 'heading', content: 'Test Heading', level: 2, encoding: 'text', attributes: MAP{}, block_order: 0}::markdown_doc_block) LIKE '## Test Heading%';
----
true

# Paragraph
query I
SELECT duck_block_to_md({block_type: 'paragraph', content: 'This is a paragraph.', level: NULL, encoding: 'text', attributes: MAP{}, block_order: 0}::markdown_doc_block) LIKE 'This is a paragraph.%';
----
true

# Code block
query I
SELECT duck_block_to_md({block_type: 'code', content: 'print("hello")', level: NULL, encoding: 'text', attributes: MAP{'language': 'python'}, block_order: 0}::markdown_doc_block) LIKE '%```python%print("hello")%```%';
----
true

# Blockquote
query I
SELECT duck_block_to_md({block_type: 'blockquote', content: 'A quote', level: 1, encoding: 'text', attributes: MAP{}, block_order: 0}::markdown_doc_block) LIKE '%> A quote%';
----
true

# List (unordered)
query I
SELECT duck_block_to_md({block_type: 'list', content: '["Item 1", "Item 2"]', level: 1, encoding: 'json', attributes: MAP{'ordered': 'false'}, block_order: 0}::markdown_doc_block) LIKE '%- Item 1%- Item 2%';
----
true

# List (ordered)
query I
SELECT duck_block_to_md({block_type: 'list', content: '["First", "Second"]', level: 1, encoding: 'json', attributes: MAP{'ordered': 'true'}, block_order: 0}::markdown_doc_block) LIKE '%1. First%2. Second%';
----
true

# Horizontal rule
query I
SELECT duck_block_to_md({block_type: 'hr', content: '', level: NULL, encoding: 'text', attributes: MAP{}, block_order: 0}::markdown_doc_block) LIKE '%---%';
----
true

# Image
query I
SELECT duck_block_to_md({block_type: 'image', content: '', level: NULL, encoding: 'text', attributes: MAP{'src': 'image.png', 'alt': 'My Image'}, block_order: 0}::markdown_doc_block) LIKE '%![My Image](image.png)%';
----
true

# Metadata/frontmatter
query I
SELECT duck_block_to_md({block_type: 'metadata', content: 'title: Test', level: 0, encoding: 'yaml', attributes: MAP{}, block_order: 0}::markdown_doc_block) LIKE '%---%title: Test%---%';
----
true

# =============================================================================
# Test: duck_blocks_to_md - List of blocks to Markdown
# =============================================================================

query I
SELECT duck_blocks_to_md([
    {block_type: 'heading', content: 'Title', level: 1, encoding: 'text', attributes: MAP{}, block_order: 0},
    {block_type: 'paragraph', content: 'Body text.', level: NULL, encoding: 'text', attributes: MAP{}, block_order: 1}
]::markdown_doc_block[]) LIKE '%# Title%Body text.%';
----
true

# Empty list
query I
SELECT duck_blocks_to_md([]::markdown_doc_block[]);
----
(empty)

# NULL handling
query I
SELECT duck_blocks_to_md(NULL::markdown_doc_block[]) IS NULL;
----
true

# =============================================================================
# Test: duck_blocks_to_sections - Convert blocks to sections
# =============================================================================

query I
SELECT len(duck_blocks_to_sections([
    {block_type: 'heading', content: 'Section One', level: 1, encoding: 'text', attributes: MAP{'id': 'section-one'}, block_order: 0},
    {block_type: 'paragraph', content: 'Content here.', level: NULL, encoding: 'text', attributes: MAP{}, block_order: 1},
    {block_type: 'heading', content: 'Section Two', level: 1, encoding: 'text', attributes: MAP{}, block_order: 2}
]::markdown_doc_block[]));
----
2

# Verify section structure
query IIII
SELECT
    s.section_id,
    s.level,
    s.title,
    length(s.content) > 0 as has_content
FROM (
    SELECT unnest(duck_blocks_to_sections([
        {block_type: 'heading', content: 'Introduction', level: 1, encoding: 'text', attributes: MAP{'id': 'intro'}, block_order: 0},
        {block_type: 'paragraph', content: 'Welcome.', level: NULL, encoding: 'text', attributes: MAP{}, block_order: 1}
    ]::markdown_doc_block[])) as s
);
----
intro	1	Introduction	true

# =============================================================================
# Test: COPY with duck_block mode
# =============================================================================

statement ok
CREATE TABLE test_blocks AS
SELECT * FROM (VALUES
    ('heading', 'My Document', 1, 'text', MAP{'id': 'my-document'}, 0),
    ('paragraph', 'First paragraph.', NULL, 'text', MAP{}, 1),
    ('code', 'SELECT 1;', NULL, 'text', MAP{'language': 'sql'}, 2)
) AS t(block_type, content, level, encoding, attributes, block_order);

statement ok
COPY test_blocks TO '__TEST_DIR__/duck_block_test.md' (FORMAT MARKDOWN, markdown_mode 'duck_block');

# Verify the file was created and contains expected content
query I
SELECT content LIKE '%# My Document%' FROM read_markdown('__TEST_DIR__/duck_block_test.md');
----
true

# =============================================================================
# Test: Round-trip blocks -> markdown -> blocks
# =============================================================================

query I
SELECT count(*) FROM read_markdown_blocks('__TEST_DIR__/duck_block_test.md');
----
3

statement ok
DROP TABLE test_blocks;

# =============================================================================
# Test: Table block rendering
# =============================================================================

query I
SELECT duck_block_to_md({
    block_type: 'table',
    content: '{"headers": ["Name", "Age"], "rows": [["Alice", "30"], ["Bob", "25"]]}',
    level: NULL,
    encoding: 'json',
    attributes: MAP{},
    block_order: 0
}::markdown_doc_block) LIKE '%| Name | Age |%|---|---|%| Alice | 30 |%';
----
true
