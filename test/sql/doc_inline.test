# name: test/sql/doc_inline.test
# description: Test duck_block functions for inline element-to-markdown conversion
# group: [sql]

require markdown

# =============================================================================
# Test: duck_block_to_md - Inline Link
# =============================================================================

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'link', content: 'Click here', level: 1, encoding: 'text', attributes: MAP{'href': 'https://example.com'}, element_order: 0});
----
[Click here](https://example.com)

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'link', content: 'Click here', level: 1, encoding: 'text', attributes: MAP{'href': 'https://example.com', 'title': 'Example Site'}, element_order: 0});
----
[Click here](https://example.com "Example Site")

# =============================================================================
# Test: duck_block_to_md - Inline Image
# =============================================================================

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'image', content: 'Alt text', level: 1, encoding: 'text', attributes: MAP{'src': 'image.png'}, element_order: 0});
----
![Alt text](image.png)

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'image', content: 'Alt text', level: 1, encoding: 'text', attributes: MAP{'src': 'image.png', 'title': 'My Image'}, element_order: 0});
----
![Alt text](image.png "My Image")

# =============================================================================
# Test: duck_block_to_md - Bold
# =============================================================================

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'bold', content: 'important', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0});
----
**important**

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'strong', content: 'also bold', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0});
----
**also bold**

# =============================================================================
# Test: duck_block_to_md - Italic
# =============================================================================

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'italic', content: 'emphasis', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0});
----
*emphasis*

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'em', content: 'also italic', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0});
----
*also italic*

# =============================================================================
# Test: duck_block_to_md - Inline Code
# =============================================================================

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'code', content: 'variable', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0});
----
`variable`

# Code with backticks uses double backtick syntax
query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'code', content: 'use `backticks`', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0});
----
`` use `backticks` ``

# =============================================================================
# Test: duck_block_to_md - Text
# =============================================================================

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'text', content: 'plain text', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0});
----
plain text

# =============================================================================
# Test: duck_block_to_md - Space and breaks
# =============================================================================

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'space', content: '', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0}) = ' ';
----
true

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'linebreak', content: '', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0}) LIKE '%  %';
----
true

# =============================================================================
# Test: duck_block_to_md - Strikethrough
# =============================================================================

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'strikethrough', content: 'deleted', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0});
----
~~deleted~~

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'del', content: 'also deleted', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0});
----
~~also deleted~~

# =============================================================================
# Test: duck_block_to_md - Superscript/Subscript
# =============================================================================

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'superscript', content: '2', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0});
----
^2^

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'subscript', content: 'i', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0});
----
~i~

# =============================================================================
# Test: duck_block_to_md - Math
# =============================================================================

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'math', content: 'x^2', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0});
----
$x^2$

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'math', content: 'E=mc^2', level: 1, encoding: 'text', attributes: MAP{'display': 'block'}, element_order: 0});
----
$$E=mc^2$$

# =============================================================================
# Test: duck_block_to_md - Smallcaps
# =============================================================================

query I
SELECT duck_block_to_md({kind: 'inline', element_type: 'smallcaps', content: 'Small Caps', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0});
----
<span style="font-variant: small-caps">Small Caps</span>

# =============================================================================
# Test: duck_block_to_md - Block element (heading)
# =============================================================================

query I
SELECT duck_block_to_md({kind: 'block', element_type: 'heading', content: 'Title', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0}) LIKE '# Title%';
----
true

query I
SELECT duck_block_to_md({kind: 'block', element_type: 'paragraph', content: 'Some text.', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 0}) LIKE 'Some text.%';
----
true

# =============================================================================
# Test: duck_blocks_to_md - List of inline elements
# =============================================================================

query I
SELECT duck_blocks_to_md([
    {kind: 'inline', element_type: 'text', content: 'Hello ', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0},
    {kind: 'inline', element_type: 'bold', content: 'world', level: 1, encoding: 'text', attributes: MAP{}, element_order: 1}
]);
----
Hello **world**

query I
SELECT duck_blocks_to_md([
    {kind: 'inline', element_type: 'text', content: 'Check out ', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0},
    {kind: 'inline', element_type: 'link', content: 'our docs', level: 1, encoding: 'text', attributes: MAP{'href': 'https://docs.example.com'}, element_order: 1},
    {kind: 'inline', element_type: 'text', content: ' for ', level: 1, encoding: 'text', attributes: MAP{}, element_order: 2},
    {kind: 'inline', element_type: 'bold', content: 'more info', level: 1, encoding: 'text', attributes: MAP{}, element_order: 3},
    {kind: 'inline', element_type: 'text', content: '.', level: 1, encoding: 'text', attributes: MAP{}, element_order: 4}
]);
----
Check out [our docs](https://docs.example.com) for **more info**.

# =============================================================================
# Test: duck_blocks_to_md - Mixed block and inline
# =============================================================================

query I
SELECT duck_blocks_to_md([
    {kind: 'block', element_type: 'heading', content: 'Title', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0},
    {kind: 'block', element_type: 'paragraph', content: 'Some text.', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 1}
]) LIKE '%# Title%Some text.%';
----
true

# =============================================================================
# Test: Using inline elements within block content
# =============================================================================

query I
SELECT duck_block_to_md({
    kind: 'block',
    element_type: 'paragraph',
    content: duck_blocks_to_md([
        {kind: 'inline', element_type: 'text', content: 'This is ', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0},
        {kind: 'inline', element_type: 'bold', content: 'important', level: 1, encoding: 'text', attributes: MAP{}, element_order: 1}
    ])::VARCHAR,
    level: NULL,
    encoding: 'text',
    attributes: MAP{},
    element_order: 0
}) LIKE 'This is **important**%';
----
true

# =============================================================================
# Test: Full document with inline content
# =============================================================================

query I
SELECT duck_blocks_to_md([
    {kind: 'block', element_type: 'heading', content: 'Welcome', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0},
    {kind: 'block', element_type: 'paragraph',
     content: duck_blocks_to_md([
         {kind: 'inline', element_type: 'text', content: 'Read the ', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0},
         {kind: 'inline', element_type: 'link', content: 'documentation', level: 1, encoding: 'text', attributes: MAP{'href': 'https://docs.example.com'}, element_order: 1},
         {kind: 'inline', element_type: 'text', content: '.', level: 1, encoding: 'text', attributes: MAP{}, element_order: 2}
     ])::VARCHAR,
     level: NULL, encoding: 'text', attributes: MAP{}, element_order: 1}
]) LIKE '%# Welcome%Read the [documentation](https://docs.example.com).%';
----
true

# =============================================================================
# Test: Issue #11 - Inline-to-block transitions
# =============================================================================

# When inline elements are followed by block elements, a paragraph break is needed
query I
SELECT duck_blocks_to_md([
    {kind: 'inline', element_type: 'text', content: 'Inline text ', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 0},
    {kind: 'inline', element_type: 'bold', content: 'bold', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 1},
    {kind: 'block', element_type: 'heading', content: 'Next Section', level: 2, encoding: 'text', attributes: MAP{}, element_order: 2}
]) LIKE 'Inline text **bold**%## Next Section%';
----
true

# Verify the newline sequence is present between inline and block
query I
SELECT duck_blocks_to_md([
    {kind: 'inline', element_type: 'text', content: 'Text', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 0},
    {kind: 'block', element_type: 'paragraph', content: 'Paragraph', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 1}
]) LIKE E'Text\n\nParagraph%';
----
true

# Block-to-block should also work correctly
query I
SELECT duck_blocks_to_md([
    {kind: 'block', element_type: 'heading', content: 'Title', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0},
    {kind: 'block', element_type: 'paragraph', content: 'Body', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 1}
]) LIKE E'# Title\n\nBody%';
----
true


# =============================================================================
# Test: Issue #10 - list_item element support
# =============================================================================

# Basic unordered list items
query I
SELECT duck_blocks_to_md([
    {kind: 'block', element_type: 'list_item', content: 'First', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0},
    {kind: 'block', element_type: 'list_item', content: 'Second', level: 1, encoding: 'text', attributes: MAP{}, element_order: 1}
]) LIKE E'- First\n- Second%';
----
true

# Ordered list items with item_number attribute
query I
SELECT duck_blocks_to_md([
    {kind: 'block', element_type: 'list_item', content: 'First', level: 1, encoding: 'text', attributes: MAP{'ordered': 'true', 'item_number': '1'}, element_order: 0},
    {kind: 'block', element_type: 'list_item', content: 'Second', level: 1, encoding: 'text', attributes: MAP{'ordered': 'true', 'item_number': '2'}, element_order: 1}
]) LIKE E'1. First\n2. Second%';
----
true

# Mixed inline and list_item elements
query I
SELECT duck_blocks_to_md([
    {kind: 'inline', element_type: 'text', content: 'Items:', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 0},
    {kind: 'block', element_type: 'list_item', content: 'Item one', level: 1, encoding: 'text', attributes: MAP{}, element_order: 1},
    {kind: 'block', element_type: 'list_item', content: 'Item two', level: 1, encoding: 'text', attributes: MAP{}, element_order: 2}
]) LIKE E'Items:\n\n- Item one\n- Item two%';
----
true

# =============================================================================
# Test: Verify generated markdown is valid
# =============================================================================

# Round-trip validation: generate markdown and verify it's valid
query I
SELECT md_valid(duck_blocks_to_md([
    {kind: 'block', element_type: 'heading', content: 'Title', level: 1, encoding: 'text', attributes: MAP{}, element_order: 0},
    {kind: 'block', element_type: 'paragraph', content: 'Content with **bold** text.', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 1},
    {kind: 'block', element_type: 'list_item', content: 'Item 1', level: 1, encoding: 'text', attributes: MAP{}, element_order: 2},
    {kind: 'block', element_type: 'list_item', content: 'Item 2', level: 1, encoding: 'text', attributes: MAP{}, element_order: 3},
    {kind: 'block', element_type: 'code', content: 'print("hello")', level: NULL, encoding: 'text', attributes: MAP{'language': 'python'}, element_order: 4}
]));
----
true

# Inline-to-block transition produces valid markdown
query I
SELECT md_valid(duck_blocks_to_md([
    {kind: 'inline', element_type: 'text', content: 'Prefix: ', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 0},
    {kind: 'inline', element_type: 'bold', content: 'important', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 1},
    {kind: 'block', element_type: 'heading', content: 'Section', level: 2, encoding: 'text', attributes: MAP{}, element_order: 2}
]));
----
true

# Single block with duck_block_to_md produces valid markdown
query I
SELECT md_valid(duck_block_to_md({
    kind: 'block', element_type: 'heading', content: 'Test Heading', level: 1,
    encoding: 'text', attributes: MAP{}, element_order: 0
}));
----
true

query I
SELECT md_valid(duck_block_to_md({
    kind: 'block', element_type: 'code', content: 'SELECT * FROM table;', level: NULL,
    encoding: 'text', attributes: MAP{'language': 'sql'}, element_order: 0
}));
----
true

query I
SELECT md_valid(duck_block_to_md({
    kind: 'block', element_type: 'blockquote', content: 'This is a quote.', level: 1,
    encoding: 'text', attributes: MAP{}, element_order: 0
}));
----
true

# Complex document with many element types
query I
SELECT md_valid(duck_blocks_to_md([
    {kind: 'block', element_type: 'frontmatter', content: 'title: Test Document', level: 0, encoding: 'yaml', attributes: MAP{}, element_order: 0},
    {kind: 'block', element_type: 'heading', content: 'Introduction', level: 1, encoding: 'text', attributes: MAP{}, element_order: 1},
    {kind: 'block', element_type: 'paragraph', content: 'Welcome to the test.', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 2},
    {kind: 'block', element_type: 'heading', content: 'Features', level: 2, encoding: 'text', attributes: MAP{}, element_order: 3},
    {kind: 'block', element_type: 'list_item', content: 'Feature one', level: 1, encoding: 'text', attributes: MAP{}, element_order: 4},
    {kind: 'block', element_type: 'list_item', content: 'Feature two', level: 1, encoding: 'text', attributes: MAP{}, element_order: 5},
    {kind: 'block', element_type: 'blockquote', content: 'Important note here.', level: 1, encoding: 'text', attributes: MAP{}, element_order: 6},
    {kind: 'block', element_type: 'code', content: 'const x = 42;', level: NULL, encoding: 'text', attributes: MAP{'language': 'javascript'}, element_order: 7},
    {kind: 'block', element_type: 'hr', content: '', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 8},
    {kind: 'block', element_type: 'paragraph', content: 'Conclusion.', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 9}
]));
----
true

# Inline elements compose valid markdown
query I
SELECT md_valid(duck_blocks_to_md([
    {kind: 'inline', element_type: 'text', content: 'Check ', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 0},
    {kind: 'inline', element_type: 'link', content: 'docs', level: NULL, encoding: 'text', attributes: MAP{'href': 'https://example.com'}, element_order: 1},
    {kind: 'inline', element_type: 'text', content: ' for ', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 2},
    {kind: 'inline', element_type: 'bold', content: 'details', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 3},
    {kind: 'inline', element_type: 'text', content: ' and ', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 4},
    {kind: 'inline', element_type: 'code', content: 'examples', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 5}
]));
----
true

# Mixed block and inline with rich content
query I
SELECT md_valid(duck_blocks_to_md([
    {kind: 'block', element_type: 'heading', content: 'Links', level: 2, encoding: 'text', attributes: MAP{}, element_order: 0},
    {kind: 'inline', element_type: 'text', content: 'Visit ', level: NULL, encoding: 'text', attributes: MAP{}, element_order: 1},
    {kind: 'inline', element_type: 'link', content: 'GitHub', level: NULL, encoding: 'text', attributes: MAP{'href': 'https://github.com'}, element_order: 2},
    {kind: 'block', element_type: 'heading', content: 'Code', level: 2, encoding: 'text', attributes: MAP{}, element_order: 3},
    {kind: 'block', element_type: 'code', content: 'echo "hello"', level: NULL, encoding: 'text', attributes: MAP{'language': 'bash'}, element_order: 4}
]));
----
true
