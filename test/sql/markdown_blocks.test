# name: test/sql/markdown_blocks.test
# description: Test read_markdown_blocks functionality and markdown_doc_block type
# group: [markdown]

require markdown

# =============================================================================
# Test: markdown_doc_block type exists
# =============================================================================

# Verify the markdown_doc_block type is registered and can be cast to
# Note: typeof() returns full struct signature, not alias name (SetAlias breaks struct_extract)
query I
SELECT ({block_type: 'heading', content: 'Test', level: 1, encoding: 'text', attributes: MAP{}, block_order: 1}::markdown_doc_block).block_type;
----
heading

# =============================================================================
# Test: Basic read_markdown_blocks from file (flattened output)
# =============================================================================

query I
SELECT count(*) FROM read_markdown_blocks('test/data/blocks_basic.md');
----
4

# =============================================================================
# Test: Block types are correctly identified
# =============================================================================

query II
SELECT block_type, level FROM read_markdown_blocks('test/data/blocks_basic.md') ORDER BY block_order;
----
heading	1
paragraph	NULL
code	NULL
blockquote	1

# =============================================================================
# Test: Heading content extraction
# =============================================================================

query II
SELECT block_type, content FROM read_markdown_blocks('test/data/blocks_basic.md') WHERE block_type = 'heading';
----
heading	Hello

# =============================================================================
# Test: Code block with language
# =============================================================================

query II
SELECT content, attributes['language'] FROM read_markdown_blocks('test/data/blocks_basic.md') WHERE block_type = 'code';
----
print("hello")	python

# =============================================================================
# Test: Frontmatter extraction
# =============================================================================

query III
SELECT block_type, level, encoding FROM read_markdown_blocks('test/data/blocks_frontmatter.md') WHERE block_type = 'frontmatter';
----
frontmatter	0	yaml

query I
SELECT content LIKE '%title: Test Doc%' FROM read_markdown_blocks('test/data/blocks_frontmatter.md') WHERE block_type = 'frontmatter';
----
true

# =============================================================================
# Test: List extraction (JSON encoded)
# =============================================================================

query II
SELECT block_type, encoding FROM read_markdown_blocks('test/data/blocks_list.md') WHERE block_type = 'list';
----
list	json

query I
SELECT attributes['ordered'] FROM read_markdown_blocks('test/data/blocks_list.md') WHERE block_type = 'list';
----
false

# =============================================================================
# Test: Ordered list
# =============================================================================

query I
SELECT attributes['ordered'] FROM read_markdown_blocks('test/data/blocks_ordered_list.md') WHERE block_type = 'list';
----
true

# =============================================================================
# Test: Horizontal rule
# =============================================================================

query I
SELECT count(*) FROM read_markdown_blocks('test/data/blocks_hr.md') WHERE block_type = 'hr';
----
1

# =============================================================================
# Test: Table extraction (JSON encoded)
# =============================================================================

query II
SELECT block_type, encoding FROM read_markdown_blocks('test/data/blocks_table.md') WHERE block_type = 'table';
----
table	json

query I
SELECT content LIKE '%"headers"%' FROM read_markdown_blocks('test/data/blocks_table.md') WHERE block_type = 'table';
----
true

# Verify headers contain the correct values (Name, Age)
query I
SELECT content LIKE '%"Name"%' AND content LIKE '%"Age"%' FROM read_markdown_blocks('test/data/blocks_table.md') WHERE block_type = 'table';
----
true

# Verify data rows contain the correct values
query I
SELECT content LIKE '%"Alice"%' AND content LIKE '%"Bob"%' FROM read_markdown_blocks('test/data/blocks_table.md') WHERE block_type = 'table';
----
true

# =============================================================================
# Test: Block order is sequential
# =============================================================================

query I
SELECT string_agg(block_order::VARCHAR, ',' ORDER BY block_order) FROM read_markdown_blocks('test/data/blocks_basic.md');
----
1,2,3,4

# =============================================================================
# Test: include_filepath option
# =============================================================================

query I
SELECT file_path LIKE '%blocks_basic.md' FROM read_markdown_blocks('test/data/blocks_basic.md', include_filepath := true) LIMIT 1;
----
true

# =============================================================================
# Test: All columns present
# =============================================================================

query IIIIII
SELECT block_type, content IS NOT NULL, level, encoding, attributes IS NOT NULL, block_order FROM read_markdown_blocks('test/data/blocks_basic.md') WHERE block_type = 'heading';
----
heading	true	1	text	true	1

# =============================================================================
# Test: Complex document with multiple block types
# =============================================================================

query I
SELECT count(*) FROM read_markdown_blocks('test/data/blocks_nested.md');
----
11

# Verify all expected block types are present
query I
SELECT count(DISTINCT block_type) FROM read_markdown_blocks('test/data/blocks_nested.md');
----
7

# Check heading levels
query II
SELECT content, level FROM read_markdown_blocks('test/data/blocks_nested.md') WHERE block_type = 'heading' ORDER BY block_order;
----
Main Heading	1
Subheading	2
Deep Heading	3

# =============================================================================
# Test: Code blocks with and without language
# =============================================================================

query II
SELECT attributes['language'], content LIKE '%SELECT%' FROM read_markdown_blocks('test/data/blocks_nested.md') WHERE block_type = 'code' ORDER BY block_order;
----
sql	true
NULL	false

# =============================================================================
# Test: Special characters in content
# =============================================================================

# Heading with inline formatting should extract text
query I
SELECT content FROM read_markdown_blocks('test/data/blocks_special.md') WHERE block_type = 'heading';
----
Heading with bold and italic

# Paragraph with inline code and links
query I
SELECT content LIKE '%inline code%' FROM read_markdown_blocks('test/data/blocks_special.md') WHERE block_type = 'paragraph';
----
true

# =============================================================================
# Test: Multiple files via glob
# =============================================================================

query I
SELECT count(*) FROM read_markdown_blocks('test/data/blocks_*.md');
----
33

query I
SELECT count(DISTINCT file_path) FROM read_markdown_blocks('test/data/blocks_*.md', include_filepath := true);
----
9

# =============================================================================
# Test: Empty file handling
# =============================================================================

statement ok
COPY (SELECT '') TO '__TEST_DIR__/empty.md' (FORMAT CSV, HEADER false, QUOTE '');

query I
SELECT count(*) FROM read_markdown_blocks('__TEST_DIR__/empty.md');
----
0

# =============================================================================
# Test: Only frontmatter
# =============================================================================

statement ok
COPY (SELECT E'---\ntitle: Only FM\n---\n') TO '__TEST_DIR__/only_fm.md' (FORMAT CSV, HEADER false, QUOTE '');

query II
SELECT block_type, level FROM read_markdown_blocks('__TEST_DIR__/only_fm.md');
----
frontmatter	0

# =============================================================================
# Test: Attributes are correctly populated
# =============================================================================

# Headings should have id attribute
query I
SELECT attributes['id'] IS NOT NULL FROM read_markdown_blocks('test/data/blocks_basic.md') WHERE block_type = 'heading';
----
true

# Lists should have ordered attribute
query I
SELECT attributes['ordered'] IN ('true', 'false') FROM read_markdown_blocks('test/data/blocks_list.md') WHERE block_type = 'list';
----
true

# =============================================================================
# Test: Blockquote content is properly extracted
# =============================================================================

query I
SELECT content FROM read_markdown_blocks('test/data/blocks_basic.md') WHERE block_type = 'blockquote';
----
A quote

# =============================================================================
# Test: List JSON content is valid
# =============================================================================

query I
SELECT content LIKE '["%' FROM read_markdown_blocks('test/data/blocks_list.md') WHERE block_type = 'list';
----
true

query I
SELECT content LIKE '%"]' FROM read_markdown_blocks('test/data/blocks_list.md') WHERE block_type = 'list';
----
true

# =============================================================================
# Test: Unicode and international characters
# =============================================================================

query I
SELECT content FROM read_markdown_blocks('test/data/blocks_unicode.md') WHERE block_type = 'heading';
----
Unicode Test 日本語

query I
SELECT content LIKE '%émojis%' FROM read_markdown_blocks('test/data/blocks_unicode.md') WHERE block_type = 'paragraph';
----
true

query I
SELECT content LIKE '%中文%' FROM read_markdown_blocks('test/data/blocks_unicode.md') WHERE block_type = 'list';
----
true

# =============================================================================
# Test: Double round-trip stability
# =============================================================================

statement ok
COPY (SELECT block_type, content, level, encoding, attributes FROM read_markdown_blocks('test/data/blocks_basic.md'))
TO '__TEST_DIR__/roundtrip1.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

statement ok
COPY (SELECT block_type, content, level, encoding, attributes FROM read_markdown_blocks('__TEST_DIR__/roundtrip1.md'))
TO '__TEST_DIR__/roundtrip2.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

# Both round-trips should have same block count
query I
SELECT (SELECT count(*) FROM read_markdown_blocks('__TEST_DIR__/roundtrip1.md')) =
       (SELECT count(*) FROM read_markdown_blocks('__TEST_DIR__/roundtrip2.md'));
----
true
