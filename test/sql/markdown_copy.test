# name: test/sql/markdown_copy.test
# description: Test COPY TO markdown functionality
# group: [sql]

require markdown

# =============================================================================
# Test: Table Mode - Basic Export
# =============================================================================

# Create a test table
statement ok
CREATE TABLE test_copy (id INTEGER, name VARCHAR, value DOUBLE);

statement ok
INSERT INTO test_copy VALUES (1, 'Alice', 10.5), (2, 'Bob', 20.0), (3, 'Charlie', 30.75);

# Test basic COPY TO markdown (default table mode)
statement ok
COPY test_copy TO '__TEST_DIR__/table_basic.md' (FORMAT MARKDOWN);

# Verify the file was created and has correct structure
query I
SELECT content LIKE '%| id |%' FROM read_text('__TEST_DIR__/table_basic.md');
----
true

# Verify header separator exists
query I
SELECT content LIKE '%|---:%' FROM read_text('__TEST_DIR__/table_basic.md');
----
true

# Verify data row exists
query I
SELECT content LIKE '%| 1 | Alice |%' FROM read_text('__TEST_DIR__/table_basic.md');
----
true

# =============================================================================
# Test: Table Mode - Explicit mode option
# =============================================================================

statement ok
COPY test_copy TO '__TEST_DIR__/table_explicit.md' (FORMAT MARKDOWN, markdown_mode 'table');

query I
SELECT content LIKE '%| id |%' FROM read_text('__TEST_DIR__/table_explicit.md');
----
true

# =============================================================================
# Test: Table Mode - Numeric alignment
# =============================================================================

# Numeric columns should be right-aligned (---:)
query I
SELECT content LIKE '%---:|%' FROM read_text('__TEST_DIR__/table_basic.md');
----
true

# =============================================================================
# Test: Table Mode - Pipe escaping
# =============================================================================

statement ok
CREATE TABLE pipe_test (val VARCHAR);

statement ok
INSERT INTO pipe_test VALUES ('a|b'), ('c|d');

statement ok
COPY pipe_test TO '__TEST_DIR__/table_pipes.md' (FORMAT MARKDOWN, escape_pipes true);

# Verify pipes are escaped (check for backslash-pipe sequence)
query I
SELECT content LIKE '%a\|b%' FROM read_text('__TEST_DIR__/table_pipes.md');
----
true

# =============================================================================
# Test: Table Mode - Newline handling
# =============================================================================

statement ok
CREATE TABLE newline_test (val VARCHAR);

statement ok
INSERT INTO newline_test VALUES (E'line1\nline2');

statement ok
COPY newline_test TO '__TEST_DIR__/table_newlines.md' (FORMAT MARKDOWN, escape_newlines true);

# Verify newlines are converted to <br>
query I
SELECT content LIKE '%<br>%' FROM read_text('__TEST_DIR__/table_newlines.md');
----
true

# =============================================================================
# Test: Table Mode - NULL handling
# =============================================================================

statement ok
CREATE TABLE null_test (id INTEGER, name VARCHAR);

statement ok
INSERT INTO null_test VALUES (1, NULL), (2, 'test');

statement ok
COPY null_test TO '__TEST_DIR__/table_nulls.md' (FORMAT MARKDOWN, null_value 'N/A');

# Verify null value replacement
query I
SELECT content LIKE '%N/A%' FROM read_text('__TEST_DIR__/table_nulls.md');
----
true

# =============================================================================
# Test: Table Mode - No header option
# =============================================================================

statement ok
COPY test_copy TO '__TEST_DIR__/table_noheader.md' (FORMAT MARKDOWN, header false);

# File should NOT have column names as first line
query I
SELECT content NOT LIKE '%| id | name |%' FROM read_text('__TEST_DIR__/table_noheader.md');
----
true

# =============================================================================
# Test: Document Mode - Basic Export
# =============================================================================

statement ok
CREATE TABLE sections (level INTEGER, title VARCHAR, content VARCHAR);

statement ok
INSERT INTO sections VALUES
    (1, 'Introduction', 'This is the intro.'),
    (2, 'Details', 'More details here.'),
    (1, 'Conclusion', 'Final thoughts.');

statement ok
COPY sections TO '__TEST_DIR__/doc_basic.md' (FORMAT MARKDOWN, markdown_mode 'document');

# Verify headings are rendered
query I
SELECT content LIKE '%# Introduction%' FROM read_text('__TEST_DIR__/doc_basic.md');
----
true

query I
SELECT content LIKE '%## Details%' FROM read_text('__TEST_DIR__/doc_basic.md');
----
true

# Verify content is included
query I
SELECT content LIKE '%This is the intro.%' FROM read_text('__TEST_DIR__/doc_basic.md');
----
true

# =============================================================================
# Test: Document Mode - With frontmatter
# =============================================================================

statement ok
COPY sections TO '__TEST_DIR__/doc_frontmatter.md' (FORMAT MARKDOWN, markdown_mode 'document', frontmatter 'title: Test Doc
author: Test Author');

# Verify frontmatter delimiters
query I
SELECT content LIKE '%---%title:%---%' OR content LIKE '%---%' FROM read_text('__TEST_DIR__/doc_frontmatter.md');
----
true

# Verify frontmatter content
query I
SELECT content LIKE '%title: Test Doc%' FROM read_text('__TEST_DIR__/doc_frontmatter.md');
----
true

# =============================================================================
# Test: Document Mode - Custom column names
# =============================================================================

statement ok
CREATE TABLE custom_sections (depth INTEGER, heading VARCHAR, body VARCHAR);

statement ok
INSERT INTO custom_sections VALUES (1, 'Custom Title', 'Custom body text.');

statement ok
COPY custom_sections TO '__TEST_DIR__/doc_custom.md' (FORMAT MARKDOWN, markdown_mode 'document',
    level_column 'depth', title_column 'heading', content_column 'body');

query I
SELECT content LIKE '%# Custom Title%' FROM read_text('__TEST_DIR__/doc_custom.md');
----
true

query I
SELECT content LIKE '%Custom body text.%' FROM read_text('__TEST_DIR__/doc_custom.md');
----
true

# =============================================================================
# Test: Document Mode - Level 0 as frontmatter
# =============================================================================

statement ok
CREATE TABLE doc_with_fm (level INTEGER, title VARCHAR, content VARCHAR);

statement ok
INSERT INTO doc_with_fm VALUES
    (0, '', 'title: Generated Doc'),
    (1, 'Body', 'Main content');

statement ok
COPY doc_with_fm TO '__TEST_DIR__/doc_level0.md' (FORMAT MARKDOWN, markdown_mode 'document');

# Level 0 should be output as frontmatter block
query I
SELECT content LIKE '%---
title: Generated Doc
---%' FROM read_text('__TEST_DIR__/doc_level0.md');
----
true

# =============================================================================
# Test: Empty table export
# =============================================================================

statement ok
CREATE TABLE empty_table (id INTEGER, name VARCHAR);

statement ok
COPY empty_table TO '__TEST_DIR__/table_empty.md' (FORMAT MARKDOWN);

# Should still have header
query I
SELECT content LIKE '%| id |%' FROM read_text('__TEST_DIR__/table_empty.md');
----
true

# =============================================================================
# Test: Query export (not just table)
# =============================================================================

statement ok
COPY (SELECT 1 as a, 'test' as b) TO '__TEST_DIR__/query_copy.md' (FORMAT MARKDOWN);

query I
SELECT content LIKE '%| a | b |%' FROM read_text('__TEST_DIR__/query_copy.md');
----
true

query I
SELECT content LIKE '%| 1 | test |%' FROM read_text('__TEST_DIR__/query_copy.md');
----
true

# =============================================================================
# Test: Blocks Mode - Basic Export (uses duck_block shape)
# =============================================================================

statement ok
CREATE TABLE blocks_test (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO blocks_test VALUES
    ('block', 'heading', 'My Document', 1, 'text', MAP{}, 0),
    ('block', 'paragraph', 'This is a paragraph.', NULL, 'text', MAP{}, 1),
    ('block', 'code', 'print("hello")', NULL, 'text', MAP{'language': 'python'}, 2),
    ('block', 'blockquote', 'A wise quote', 1, 'text', MAP{}, 3);

statement ok
COPY blocks_test TO '__TEST_DIR__/blocks_basic.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

# Verify heading
query I
SELECT content LIKE '%# My Document%' FROM read_text('__TEST_DIR__/blocks_basic.md');
----
true

# Verify paragraph
query I
SELECT content LIKE '%This is a paragraph.%' FROM read_text('__TEST_DIR__/blocks_basic.md');
----
true

# Verify code block with language
query I
SELECT content LIKE '%```python%' FROM read_text('__TEST_DIR__/blocks_basic.md');
----
true

# Verify code content
query I
SELECT content LIKE '%print("hello")%' FROM read_text('__TEST_DIR__/blocks_basic.md');
----
true

# Verify blockquote
query I
SELECT content LIKE '%> A wise quote%' FROM read_text('__TEST_DIR__/blocks_basic.md');
----
true

# =============================================================================
# Test: Blocks Mode - Frontmatter
# =============================================================================

statement ok
CREATE TABLE blocks_fm (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO blocks_fm VALUES
    ('block', 'frontmatter', 'title: Test', 0, 'yaml', MAP{}, 0),
    ('block', 'heading', 'Content', 1, 'text', MAP{}, 1);

statement ok
COPY blocks_fm TO '__TEST_DIR__/blocks_fm.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content LIKE '%---%title: Test%---%' FROM read_text('__TEST_DIR__/blocks_fm.md');
----
true

# =============================================================================
# Test: Blocks Mode - Lists
# =============================================================================

statement ok
CREATE TABLE blocks_list (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO blocks_list VALUES
    ('block', 'list', '["Item 1", "Item 2", "Item 3"]', 1, 'json', MAP{'ordered': 'false'}, 0);

statement ok
COPY blocks_list TO '__TEST_DIR__/blocks_list.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content LIKE '%- Item 1%' FROM read_text('__TEST_DIR__/blocks_list.md');
----
true

# =============================================================================
# Test: Blocks Mode - Horizontal Rule
# =============================================================================

statement ok
CREATE TABLE blocks_hr (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO blocks_hr VALUES
    ('block', 'heading', 'Before', 1, 'text', MAP{}, 0),
    ('block', 'hr', '', NULL, 'text', MAP{}, 1),
    ('block', 'heading', 'After', 1, 'text', MAP{}, 2);

statement ok
COPY blocks_hr TO '__TEST_DIR__/blocks_hr.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content LIKE '%---%' FROM read_text('__TEST_DIR__/blocks_hr.md');
----
true

# =============================================================================
# Test: Blocks Mode - Round-trip with duck_block shape
# =============================================================================

# Read blocks from a file and write them back
statement ok
COPY (SELECT kind, element_type, content, level, encoding, attributes FROM read_markdown_blocks('test/data/blocks_basic.md'))
TO '__TEST_DIR__/blocks_roundtrip.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

# Verify the roundtrip preserved structure
query I
SELECT content LIKE '%# Hello%' FROM read_text('__TEST_DIR__/blocks_roundtrip.md');
----
true

query I
SELECT content LIKE '%```python%' FROM read_text('__TEST_DIR__/blocks_roundtrip.md');
----
true

# =============================================================================
# Test: Blocks Mode - Ordered list with start
# =============================================================================

statement ok
CREATE TABLE blocks_olist (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO blocks_olist VALUES
    ('block', 'list', '["First", "Second", "Third"]', 1, 'json', MAP{'ordered': 'true', 'start': '5'}, 0);

statement ok
COPY blocks_olist TO '__TEST_DIR__/blocks_olist.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content LIKE '%5. First%' FROM read_text('__TEST_DIR__/blocks_olist.md');
----
true

query I
SELECT content LIKE '%6. Second%' FROM read_text('__TEST_DIR__/blocks_olist.md');
----
true

# =============================================================================
# Test: Blocks Mode - Code block without language
# =============================================================================

statement ok
CREATE TABLE blocks_code_nolang (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO blocks_code_nolang VALUES
    ('block', 'code', 'plain code here', NULL, 'text', MAP{}, 0);

statement ok
COPY blocks_code_nolang TO '__TEST_DIR__/blocks_code_nolang.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

# Should have ``` without language
query I
SELECT content LIKE E'```\nplain code here\n```%' FROM read_text('__TEST_DIR__/blocks_code_nolang.md');
----
true

# =============================================================================
# Test: Blocks Mode - Multiple heading levels
# =============================================================================

statement ok
CREATE TABLE blocks_headings (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO blocks_headings VALUES
    ('block', 'heading', 'Level 1', 1, 'text', MAP{}, 0),
    ('block', 'heading', 'Level 2', 2, 'text', MAP{}, 1),
    ('block', 'heading', 'Level 3', 3, 'text', MAP{}, 2),
    ('block', 'heading', 'Level 4', 4, 'text', MAP{}, 3),
    ('block', 'heading', 'Level 5', 5, 'text', MAP{}, 4),
    ('block', 'heading', 'Level 6', 6, 'text', MAP{}, 5);

statement ok
COPY blocks_headings TO '__TEST_DIR__/blocks_headings.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content LIKE '%# Level 1%' FROM read_text('__TEST_DIR__/blocks_headings.md');
----
true

query I
SELECT content LIKE '%## Level 2%' FROM read_text('__TEST_DIR__/blocks_headings.md');
----
true

query I
SELECT content LIKE '%###### Level 6%' FROM read_text('__TEST_DIR__/blocks_headings.md');
----
true

# =============================================================================
# Test: Blocks Mode - Special characters
# =============================================================================

statement ok
CREATE TABLE blocks_special (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO blocks_special VALUES
    ('block', 'paragraph', 'Text with "quotes" and special chars: <>&', NULL, 'text', MAP{}, 0);

statement ok
COPY blocks_special TO '__TEST_DIR__/blocks_special.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content LIKE '%"quotes"%' FROM read_text('__TEST_DIR__/blocks_special.md');
----
true

# =============================================================================
# Test: Blocks Mode - Table round-trip renders markdown
# =============================================================================

statement ok
COPY (SELECT kind, element_type, content, level, encoding, attributes FROM read_markdown_blocks('test/data/blocks_table.md'))
TO '__TEST_DIR__/blocks_table_roundtrip.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

# Should render as proper markdown table, not JSON
query I
SELECT content LIKE '%| Name | Age |%' FROM read_text('__TEST_DIR__/blocks_table_roundtrip.md');
----
true

query I
SELECT content LIKE '%|---|---|%' FROM read_text('__TEST_DIR__/blocks_table_roundtrip.md');
----
true

query I
SELECT content LIKE '%| Alice | 30 |%' FROM read_text('__TEST_DIR__/blocks_table_roundtrip.md');
----
true

# Should NOT contain raw JSON
query I
SELECT content NOT LIKE '%"headers"%' FROM read_text('__TEST_DIR__/blocks_table_roundtrip.md');
----
true

# =============================================================================
# Test: Clean up additional blocks tables
# =============================================================================

statement ok
DROP TABLE blocks_olist;

statement ok
DROP TABLE blocks_code_nolang;

statement ok
DROP TABLE blocks_headings;

statement ok
DROP TABLE blocks_special;

# =============================================================================
# Test: Clean up blocks tables
# =============================================================================

statement ok
DROP TABLE blocks_test;

statement ok
DROP TABLE blocks_fm;

statement ok
DROP TABLE blocks_list;

statement ok
DROP TABLE blocks_hr;

# =============================================================================
# Test: Error handling - invalid markdown_mode
# =============================================================================

statement error
COPY (SELECT 1 as x) TO '__TEST_DIR__/invalid.md' (FORMAT MARKDOWN, markdown_mode 'invalid');
----
Invalid markdown_mode

# =============================================================================
# Test: Error handling - missing element_type column
# =============================================================================

statement error
COPY (SELECT 'content' as content) TO '__TEST_DIR__/missing.md' (FORMAT MARKDOWN, markdown_mode 'blocks');
----
Blocks mode requires a 'element_type' column

# =============================================================================
# Test: Error handling - missing level column for document mode
# =============================================================================

statement error
COPY (SELECT 'title' as title, 'content' as content) TO '__TEST_DIR__/missing.md' (FORMAT MARKDOWN, markdown_mode 'document');
----
Document mode requires a 'level' column

# =============================================================================
# Test: Blocks mode with minimal columns
# =============================================================================

statement ok
COPY (SELECT 'heading' as element_type, 'Minimal' as content) TO '__TEST_DIR__/minimal.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content LIKE '%# Minimal%' FROM read_text('__TEST_DIR__/minimal.md');
----
true

# =============================================================================
# Test: Blocks mode with custom column names
# =============================================================================

statement ok
COPY (SELECT 'heading' as type, 'Custom' as body, 2 as depth)
TO '__TEST_DIR__/custom_cols.md' (FORMAT MARKDOWN, markdown_mode 'blocks',
    element_type_column 'type', content_column 'body', level_column 'depth');

query I
SELECT content LIKE '%## Custom%' FROM read_text('__TEST_DIR__/custom_cols.md');
----
true

# =============================================================================
# Test: Blocks Mode - Inline elements render without trailing newlines
# =============================================================================

# Create a table with inline elements
statement ok
CREATE TABLE inline_test (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

# Insert inline elements that should concatenate together
statement ok
INSERT INTO inline_test VALUES
    ('inline', 'text', 'This has ', 1, 'text', MAP{}, 0),
    ('inline', 'bold', 'bold', 1, 'text', MAP{}, 1),
    ('inline', 'text', ' and ', 1, 'text', MAP{}, 2),
    ('inline', 'italic', 'italic', 1, 'text', MAP{}, 3),
    ('inline', 'text', ' text.', 1, 'text', MAP{}, 4);

statement ok
COPY inline_test TO '__TEST_DIR__/inline_basic.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

# Verify inline elements are concatenated without newlines between them
query I
SELECT content = 'This has **bold** and *italic* text.' FROM read_text('__TEST_DIR__/inline_basic.md');
----
true

# =============================================================================
# Test: Blocks Mode - Inline link element
# =============================================================================

statement ok
CREATE TABLE inline_link (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO inline_link VALUES
    ('inline', 'text', 'Check out ', 1, 'text', MAP{}, 0),
    ('inline', 'link', 'our docs', 1, 'text', MAP{'href': 'https://example.com'}, 1),
    ('inline', 'text', ' for more.', 1, 'text', MAP{}, 2);

statement ok
COPY inline_link TO '__TEST_DIR__/inline_link.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

# Verify link is rendered correctly inline
query I
SELECT content = 'Check out [our docs](https://example.com) for more.' FROM read_text('__TEST_DIR__/inline_link.md');
----
true

# =============================================================================
# Test: Blocks Mode - Inline link with title
# =============================================================================

statement ok
CREATE TABLE inline_link_title (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO inline_link_title VALUES
    ('inline', 'link', 'Click here', 1, 'text', MAP{'href': 'https://example.com', 'title': 'Example Site'}, 0);

statement ok
COPY inline_link_title TO '__TEST_DIR__/inline_link_title.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content = '[Click here](https://example.com "Example Site")' FROM read_text('__TEST_DIR__/inline_link_title.md');
----
true

# =============================================================================
# Test: Blocks Mode - Mixed block and inline elements
# =============================================================================

statement ok
CREATE TABLE mixed_elements (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO mixed_elements VALUES
    ('block', 'heading', 'Document with Rich Content', 1, 'text', MAP{}, 0),
    ('inline', 'text', 'This has ', 1, 'text', MAP{}, 1),
    ('inline', 'bold', 'bold', 1, 'text', MAP{}, 2),
    ('inline', 'text', ' and ', 1, 'text', MAP{}, 3),
    ('inline', 'italic', 'italic', 1, 'text', MAP{}, 4),
    ('inline', 'text', ' text.', 1, 'text', MAP{}, 5),
    ('block', 'paragraph', 'A regular paragraph.', 1, 'text', MAP{}, 6);

statement ok
COPY mixed_elements TO '__TEST_DIR__/mixed_elements.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

# Verify heading is a block (has trailing newlines)
query I
SELECT content LIKE E'# Document with Rich Content\n\n%' FROM read_text('__TEST_DIR__/mixed_elements.md');
----
true

# Verify inline elements are concatenated and properly separated from next block
query I
SELECT content LIKE E'%This has **bold** and *italic* text.\n\nA regular paragraph.\n\n' FROM read_text('__TEST_DIR__/mixed_elements.md');
----
true

# =============================================================================
# Test: Blocks Mode - Block to inline to block transitions
# =============================================================================

statement ok
CREATE TABLE block_inline_block (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO block_inline_block VALUES
    ('block', 'heading', 'Section Title', 1, 'text', MAP{}, 0),
    ('inline', 'text', 'Some ', 1, 'text', MAP{}, 1),
    ('inline', 'bold', 'important', 1, 'text', MAP{}, 2),
    ('inline', 'text', ' text here.', 1, 'text', MAP{}, 3),
    ('block', 'code', 'print("hello")', 1, 'text', MAP{'language': 'python'}, 4),
    ('inline', 'text', 'More ', 1, 'text', MAP{}, 5),
    ('inline', 'italic', 'styled', 1, 'text', MAP{}, 6),
    ('inline', 'text', ' content.', 1, 'text', MAP{}, 7),
    ('block', 'paragraph', 'Final paragraph.', 1, 'text', MAP{}, 8);

statement ok
COPY block_inline_block TO '__TEST_DIR__/block_inline_block.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

# Verify the full structure with proper transitions
query I
SELECT content = E'# Section Title\n\nSome **important** text here.\n\n```python\nprint("hello")\n```\n\nMore *styled* content.\n\nFinal paragraph.\n\n' FROM read_text('__TEST_DIR__/block_inline_block.md');
----
true

# =============================================================================
# Test: Blocks Mode - Multiple consecutive blocks
# =============================================================================

statement ok
CREATE TABLE consecutive_blocks (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO consecutive_blocks VALUES
    ('block', 'heading', 'First Heading', 1, 'text', MAP{}, 0),
    ('block', 'paragraph', 'First paragraph.', 1, 'text', MAP{}, 1),
    ('block', 'heading', 'Second Heading', 2, 'text', MAP{}, 2),
    ('block', 'paragraph', 'Second paragraph.', 1, 'text', MAP{}, 3);

statement ok
COPY consecutive_blocks TO '__TEST_DIR__/consecutive_blocks.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

# Verify blocks are properly separated
query I
SELECT content = E'# First Heading\n\nFirst paragraph.\n\n## Second Heading\n\nSecond paragraph.\n\n' FROM read_text('__TEST_DIR__/consecutive_blocks.md');
----
true

# =============================================================================
# Test: Blocks Mode - Inline only document (no trailing block)
# =============================================================================

statement ok
CREATE TABLE inline_only (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO inline_only VALUES
    ('inline', 'text', 'Just ', 1, 'text', MAP{}, 0),
    ('inline', 'bold', 'inline', 1, 'text', MAP{}, 1),
    ('inline', 'text', ' content.', 1, 'text', MAP{}, 2);

statement ok
COPY inline_only TO '__TEST_DIR__/inline_only.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

# Inline-only content should concatenate without trailing newlines
query I
SELECT content = 'Just **inline** content.' FROM read_text('__TEST_DIR__/inline_only.md');
----
true

# =============================================================================
# Test: Blocks Mode - Block only document
# =============================================================================

statement ok
CREATE TABLE block_only (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO block_only VALUES
    ('block', 'heading', 'Title', 1, 'text', MAP{}, 0),
    ('block', 'paragraph', 'Content.', 1, 'text', MAP{}, 1);

statement ok
COPY block_only TO '__TEST_DIR__/block_only.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content = E'# Title\n\nContent.\n\n' FROM read_text('__TEST_DIR__/block_only.md');
----
true

# =============================================================================
# Test: Blocks Mode - Inline to block with list
# =============================================================================

statement ok
CREATE TABLE inline_to_list (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO inline_to_list VALUES
    ('block', 'heading', 'Shopping List', 1, 'text', MAP{}, 0),
    ('inline', 'text', 'Here are the ', 1, 'text', MAP{}, 1),
    ('inline', 'bold', 'items', 1, 'text', MAP{}, 2),
    ('inline', 'text', ' we need:', 1, 'text', MAP{}, 3),
    ('block', 'list', '["Apples", "Bananas", "Oranges"]', 1, 'json', MAP{'ordered': 'false'}, 4);

statement ok
COPY inline_to_list TO '__TEST_DIR__/inline_to_list.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

# Verify proper separation between inline and list
query I
SELECT content = E'# Shopping List\n\nHere are the **items** we need:\n\n- Apples\n- Bananas\n- Oranges\n\n' FROM read_text('__TEST_DIR__/inline_to_list.md');
----
true

# =============================================================================
# Test: Blocks Mode - Complex document with all element types
# =============================================================================

statement ok
CREATE TABLE complex_doc (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO complex_doc VALUES
    ('block', 'heading', 'My Document', 1, 'text', MAP{}, 0),
    ('inline', 'text', 'This is an ', 1, 'text', MAP{}, 1),
    ('inline', 'bold', 'introduction', 1, 'text', MAP{}, 2),
    ('inline', 'text', ' with a ', 1, 'text', MAP{}, 3),
    ('inline', 'link', 'link', 1, 'text', MAP{'href': 'https://example.com'}, 4),
    ('inline', 'text', '.', 1, 'text', MAP{}, 5),
    ('block', 'heading', 'Code Example', 2, 'text', MAP{}, 6),
    ('block', 'code', 'x = 1', 1, 'text', MAP{'language': 'python'}, 7),
    ('block', 'heading', 'Conclusion', 2, 'text', MAP{}, 8),
    ('inline', 'text', 'The ', 1, 'text', MAP{}, 9),
    ('inline', 'italic', 'end', 1, 'text', MAP{}, 10),
    ('inline', 'text', '.', 1, 'text', MAP{}, 11);

statement ok
COPY complex_doc TO '__TEST_DIR__/complex_doc.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

# Verify heading
query I
SELECT content LIKE E'# My Document\n\n%' FROM read_text('__TEST_DIR__/complex_doc.md');
----
true

# Verify inline with link followed by heading
query I
SELECT content LIKE E'%This is an **introduction** with a [link](https://example.com).\n\n## Code Example\n\n%' FROM read_text('__TEST_DIR__/complex_doc.md');
----
true

# Verify code block followed by heading
query I
SELECT content LIKE E'%```python\nx = 1\n```\n\n## Conclusion\n\n%' FROM read_text('__TEST_DIR__/complex_doc.md');
----
true

# Verify final inline content (no trailing block means no trailing newlines)
query I
SELECT content LIKE '%The *end*.' FROM read_text('__TEST_DIR__/complex_doc.md');
----
true

# =============================================================================
# Test: Blocks Mode - Blockquote after inline
# =============================================================================

statement ok
CREATE TABLE inline_to_quote (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO inline_to_quote VALUES
    ('inline', 'text', 'As someone once said:', 1, 'text', MAP{}, 0),
    ('block', 'blockquote', 'To be or not to be.', 1, 'text', MAP{}, 1);

statement ok
COPY inline_to_quote TO '__TEST_DIR__/inline_to_quote.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content = E'As someone once said:\n\n> To be or not to be.\n\n' FROM read_text('__TEST_DIR__/inline_to_quote.md');
----
true

# =============================================================================
# Test: Blocks Mode - HR between inline sections
# =============================================================================

statement ok
CREATE TABLE inline_hr_inline (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO inline_hr_inline VALUES
    ('inline', 'text', 'Section one ', 1, 'text', MAP{}, 0),
    ('inline', 'bold', 'content', 1, 'text', MAP{}, 1),
    ('inline', 'text', '.', 1, 'text', MAP{}, 2),
    ('block', 'hr', '', 1, 'text', MAP{}, 3),
    ('inline', 'text', 'Section two ', 1, 'text', MAP{}, 4),
    ('inline', 'italic', 'content', 1, 'text', MAP{}, 5),
    ('inline', 'text', '.', 1, 'text', MAP{}, 6);

statement ok
COPY inline_hr_inline TO '__TEST_DIR__/inline_hr_inline.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content = E'Section one **content**.\n\n---\n\nSection two *content*.' FROM read_text('__TEST_DIR__/inline_hr_inline.md');
----
true

# =============================================================================
# Test: Blocks Mode - Table after inline
# =============================================================================

statement ok
CREATE TABLE inline_to_table (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO inline_to_table VALUES
    ('inline', 'text', 'Here is the ', 1, 'text', MAP{}, 0),
    ('inline', 'bold', 'data', 1, 'text', MAP{}, 1),
    ('inline', 'text', ':', 1, 'text', MAP{}, 2),
    ('block', 'table', '{"headers": ["Name", "Value"], "rows": [["A", "1"], ["B", "2"]]}', 1, 'json', MAP{}, 3);

statement ok
COPY inline_to_table TO '__TEST_DIR__/inline_to_table.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

# Verify inline followed by table with proper separation
query I
SELECT content LIKE E'Here is the **data**:\n\n| Name | Value |\n|---|---|\n| A | 1 |\n| B | 2 |\n\n' FROM read_text('__TEST_DIR__/inline_to_table.md');
----
true

# =============================================================================
# Test: Clean up new transition test tables
# =============================================================================

statement ok
DROP TABLE block_inline_block;

statement ok
DROP TABLE consecutive_blocks;

statement ok
DROP TABLE inline_only;

statement ok
DROP TABLE block_only;

statement ok
DROP TABLE inline_to_list;

statement ok
DROP TABLE complex_doc;

statement ok
DROP TABLE inline_to_quote;

statement ok
DROP TABLE inline_hr_inline;

statement ok
DROP TABLE inline_to_table;

# =============================================================================
# Test: Blocks Mode - Inline code element
# =============================================================================

statement ok
CREATE TABLE inline_code (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO inline_code VALUES
    ('inline', 'text', 'Use the ', 1, 'text', MAP{}, 0),
    ('inline', 'code', 'print()', 1, 'text', MAP{}, 1),
    ('inline', 'text', ' function.', 1, 'text', MAP{}, 2);

statement ok
COPY inline_code TO '__TEST_DIR__/inline_code.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content = 'Use the `print()` function.' FROM read_text('__TEST_DIR__/inline_code.md');
----
true

# =============================================================================
# Test: Blocks Mode - Inline strikethrough
# =============================================================================

statement ok
CREATE TABLE inline_strike (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO inline_strike VALUES
    ('inline', 'text', 'This is ', 1, 'text', MAP{}, 0),
    ('inline', 'strikethrough', 'wrong', 1, 'text', MAP{}, 1),
    ('inline', 'text', ' correct.', 1, 'text', MAP{}, 2);

statement ok
COPY inline_strike TO '__TEST_DIR__/inline_strike.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content = 'This is ~~wrong~~ correct.' FROM read_text('__TEST_DIR__/inline_strike.md');
----
true

# =============================================================================
# Test: Blocks Mode - Inline image
# =============================================================================

statement ok
CREATE TABLE inline_image (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO inline_image VALUES
    ('inline', 'image', 'alt text', 1, 'text', MAP{'src': 'image.png'}, 0);

statement ok
COPY inline_image TO '__TEST_DIR__/inline_image.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content = '![alt text](image.png)' FROM read_text('__TEST_DIR__/inline_image.md');
----
true

# =============================================================================
# Test: Blocks Mode - Inline math
# =============================================================================

statement ok
CREATE TABLE inline_math (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO inline_math VALUES
    ('inline', 'text', 'The formula ', 1, 'text', MAP{}, 0),
    ('inline', 'math', 'E=mc^2', 1, 'text', MAP{}, 1),
    ('inline', 'text', ' is famous.', 1, 'text', MAP{}, 2);

statement ok
COPY inline_math TO '__TEST_DIR__/inline_math.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content = 'The formula $E=mc^2$ is famous.' FROM read_text('__TEST_DIR__/inline_math.md');
----
true

# =============================================================================
# Test: Blocks Mode - Block math (display mode)
# =============================================================================

statement ok
CREATE TABLE block_math (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO block_math VALUES
    ('inline', 'math', 'x = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}', 1, 'text', MAP{'display': 'block'}, 0);

statement ok
COPY block_math TO '__TEST_DIR__/block_math.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content = '$$x = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}$$' FROM read_text('__TEST_DIR__/block_math.md');
----
true

# =============================================================================
# Test: Blocks Mode - Inline superscript and subscript
# =============================================================================

statement ok
CREATE TABLE inline_super_sub (kind VARCHAR, element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO inline_super_sub VALUES
    ('inline', 'text', 'H', 1, 'text', MAP{}, 0),
    ('inline', 'subscript', '2', 1, 'text', MAP{}, 1),
    ('inline', 'text', 'O and x', 1, 'text', MAP{}, 2),
    ('inline', 'superscript', '2', 1, 'text', MAP{}, 3);

statement ok
COPY inline_super_sub TO '__TEST_DIR__/inline_super_sub.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

query I
SELECT content = 'H~2~O and x^2^' FROM read_text('__TEST_DIR__/inline_super_sub.md');
----
true

# =============================================================================
# Test: Blocks Mode - Inline without kind column (defaults to block)
# =============================================================================

statement ok
CREATE TABLE no_kind (element_type VARCHAR, content VARCHAR, level INTEGER, encoding VARCHAR, attributes MAP(VARCHAR, VARCHAR), element_order INTEGER);

statement ok
INSERT INTO no_kind VALUES
    ('heading', 'Title', 1, 'text', MAP{}, 0),
    ('paragraph', 'Content here.', 1, 'text', MAP{}, 1);

statement ok
COPY no_kind TO '__TEST_DIR__/no_kind.md' (FORMAT MARKDOWN, markdown_mode 'blocks');

# Without kind column, defaults to block behavior
query I
SELECT content LIKE E'# Title\n\nContent here.\n\n' FROM read_text('__TEST_DIR__/no_kind.md');
----
true

# =============================================================================
# Test: Clean up inline test tables
# =============================================================================

statement ok
DROP TABLE inline_test;

statement ok
DROP TABLE inline_link;

statement ok
DROP TABLE inline_link_title;

statement ok
DROP TABLE mixed_elements;

statement ok
DROP TABLE inline_code;

statement ok
DROP TABLE inline_strike;

statement ok
DROP TABLE inline_image;

statement ok
DROP TABLE inline_math;

statement ok
DROP TABLE block_math;

statement ok
DROP TABLE inline_super_sub;

statement ok
DROP TABLE no_kind;

# =============================================================================
# Test: Clean up
# =============================================================================

statement ok
DROP TABLE test_copy;

statement ok
DROP TABLE pipe_test;

statement ok
DROP TABLE newline_test;

statement ok
DROP TABLE null_test;

statement ok
DROP TABLE sections;

statement ok
DROP TABLE custom_sections;

statement ok
DROP TABLE doc_with_fm;

statement ok
DROP TABLE empty_table;
