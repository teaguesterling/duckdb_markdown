name: WASM Integration Test

on:
  workflow_run:
    workflows: ["Main Extension Distribution Pipeline"]
    types: [completed]
  workflow_dispatch:
    inputs:
      duckdb_wasm_version:
        description: 'duckdb-wasm npm version to test'
        required: false
        default: '1.32.0'

jobs:
  test-wasm-browser:
    name: Test WASM in Browser
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download WASM extension artifact
        uses: actions/download-artifact@v4
        with:
          name: markdown-main-extension-wasm_eh
          path: wasm-ext
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        if: github.event_name == 'workflow_run'

      - name: Download WASM extension (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          mkdir -p wasm-ext
          gh run download --name markdown-main-extension-wasm_eh --dir wasm-ext || echo "No artifact found, will skip extension test"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create test directory
        run: mkdir -p wasm-test

      - name: Install dependencies
        working-directory: wasm-test
        run: |
          npm init -y
          npm install @duckdb/duckdb-wasm@${{ inputs.duckdb_wasm_version || '1.32.0' }} playwright
          npx playwright install chromium

      - name: Copy extension to duckdb-wasm dist
        run: |
          if [ -f wasm-ext/markdown.duckdb_extension.wasm ]; then
            cp wasm-ext/markdown.duckdb_extension.wasm wasm-test/node_modules/@duckdb/duckdb-wasm/dist/
            echo "Extension file copied to duckdb-wasm dist"
          else
            echo "No extension file found"
          fi

      - name: Create browser test
        run: |
          cat > wasm-test/test-browser.mjs << 'TESTSCRIPT'
          import { chromium } from 'playwright';
          import { createServer } from 'http';
          import { readFileSync, writeFileSync } from 'fs';
          import { resolve, dirname } from 'path';
          import { fileURLToPath } from 'url';

          const __dirname = dirname(fileURLToPath(import.meta.url));

          // Simple static file server
          const server = createServer((req, res) => {
            let filePath = resolve(__dirname, req.url === '/' ? 'index.html' : req.url.slice(1));
            if (req.url.startsWith('/node_modules/')) {
              filePath = resolve(__dirname, req.url.slice(1));
            }

            try {
              const content = readFileSync(filePath);
              const ext = filePath.split('.').pop();
              const types = {
                'html': 'text/html',
                'js': 'application/javascript',
                'mjs': 'application/javascript',
                'wasm': 'application/wasm',
                'json': 'application/json'
              };
              res.writeHead(200, {
                'Content-Type': types[ext] || 'application/octet-stream',
                'Content-Length': content.length
              });
              res.end(content);
            } catch (e) {
              console.error('404:', req.url);
              res.writeHead(404);
              res.end('Not found');
            }
          });

          const PORT = 8765;

          // Create HTML test page
          const htmlContent = `<!DOCTYPE html>
          <html>
          <head><title>DuckDB WASM Markdown Test</title></head>
          <body>
          <div id="output"></div>
          <script type="module">
            import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.32.0/+esm';

            const log = (msg) => {
              document.getElementById('output').innerHTML += msg + '<br>';
              console.log(msg);
            };

            window.runTest = async () => {
              const results = { passed: 0, failed: 0, knownFail: 0, errors: [] };

              try {
                log('=== DuckDB WASM Markdown Extension Test ===');

                // Use local bundles to avoid CORS issues with workers
                const BUNDLES = {
                  mvp: {
                    mainModule: '/node_modules/@duckdb/duckdb-wasm/dist/duckdb-mvp.wasm',
                    mainWorker: '/node_modules/@duckdb/duckdb-wasm/dist/duckdb-browser-mvp.worker.js',
                  },
                  eh: {
                    mainModule: '/node_modules/@duckdb/duckdb-wasm/dist/duckdb-eh.wasm',
                    mainWorker: '/node_modules/@duckdb/duckdb-wasm/dist/duckdb-browser-eh.worker.js',
                  },
                };
                const bundle = await duckdb.selectBundle(BUNDLES);
                log('Bundle: ' + bundle.mainModule.split('/').pop());

                const worker = new Worker(bundle.mainWorker);
                const logger = new duckdb.ConsoleLogger(duckdb.LogLevel.WARNING);
                const db = new duckdb.AsyncDuckDB(logger, worker);

                await db.instantiate(bundle.mainModule);
                await db.open({ allowUnsignedExtensions: true });
                log('DuckDB ready (unsigned extensions allowed)');

                const conn = await db.connect();
                const version = await conn.query('SELECT version() as v');
                log('DuckDB version: ' + version.toArray()[0].v);

                // Load extension
                try {
                  await conn.query("LOAD 'markdown.duckdb_extension.wasm'");
                  log('Extension loaded');
                  results.passed++;
                } catch (e) {
                  log('FAIL: Extension load: ' + e.message);
                  results.failed++;
                  results.errors.push('load: ' + e.message);
                  window.testResults = results;
                  return;
                }

                // Register test file
                const testMd = '# Hello\\n\\nParagraph text.\\n\\n## Section\\n\\n- Item 1\\n- Item 2\\n';
                await db.registerFileText('test.md', testMd);

                // Test read_markdown (expected to work)
                try {
                  await conn.query("SELECT content FROM read_markdown('test.md')");
                  log('read_markdown: OK');
                  results.passed++;
                } catch (e) {
                  log('FAIL: read_markdown: ' + e.message);
                  results.failed++;
                  results.errors.push('read_markdown: ' + e.message);
                }

                // Test read_markdown_sections (known to fail due to cmark-gfm function pointer issues)
                try {
                  await conn.query("SELECT count(*) as n FROM read_markdown_sections('test.md')");
                  log('read_markdown_sections: OK');
                  results.passed++;
                } catch (e) {
                  if (e.message.includes('table index is out of bounds')) {
                    log('KNOWN ISSUE: read_markdown_sections has WASM function pointer issue');
                    results.knownFail++;
                  } else {
                    log('FAIL: read_markdown_sections: ' + e.message);
                    results.failed++;
                    results.errors.push('read_markdown_sections: ' + e.message);
                  }
                }

                // Test read_markdown_blocks (known to fail due to cmark-gfm function pointer issues)
                try {
                  await conn.query("SELECT element_type FROM read_markdown_blocks('test.md')");
                  log('read_markdown_blocks: OK');
                  results.passed++;
                } catch (e) {
                  if (e.message.includes('table index is out of bounds')) {
                    log('KNOWN ISSUE: read_markdown_blocks has WASM function pointer issue');
                    results.knownFail++;
                  } else {
                    log('FAIL: read_markdown_blocks: ' + e.message);
                    results.failed++;
                    results.errors.push('read_markdown_blocks: ' + e.message);
                  }
                }

                await conn.close();
                await db.terminate();
                worker.terminate();

                log('');
                log('=== Results: ' + results.passed + ' passed, ' + results.failed + ' failed, ' + results.knownFail + ' known issues ===');

              } catch (e) {
                log('FATAL: ' + e.message);
                results.failed++;
                results.errors.push('fatal: ' + e.message);
              }

              window.testResults = results;
            };

            runTest();
          </script>
          </body>
          </html>`;

          writeFileSync(resolve(__dirname, 'index.html'), htmlContent);

          server.listen(PORT, async () => {
            console.log('Server running on http://localhost:' + PORT);

            const browser = await chromium.launch();
            const page = await browser.newPage();
            page.on('console', msg => console.log('Browser:', msg.text()));

            await page.goto('http://localhost:' + PORT);
            await page.waitForFunction(() => window.testResults !== undefined, { timeout: 120000 });

            const results = await page.evaluate(() => window.testResults);
            console.log('\\nTest Results:', JSON.stringify(results, null, 2));

            await browser.close();
            server.close();

            // Pass if extension loads and read_markdown works
            // Known issues with sections/blocks are acceptable for now
            const success = results.passed >= 2 && results.failed === 0;
            console.log(success ? '\\nWASM test PASSED' : '\\nWASM test FAILED');
            process.exit(success ? 0 : 1);
          });
          TESTSCRIPT

      - name: Run browser tests
        working-directory: wasm-test
        run: node test-browser.mjs
        timeout-minutes: 5

      - name: Summary
        if: always()
        run: |
          echo "## WASM Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- duckdb-wasm: ${{ inputs.duckdb_wasm_version || '1.32.0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test type: Browser (Playwright + Chromium)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Current WASM Support Status" >> $GITHUB_STEP_SUMMARY
          echo "- Extension loading: Working" >> $GITHUB_STEP_SUMMARY
          echo "- read_markdown(): Working" >> $GITHUB_STEP_SUMMARY
          echo "- read_markdown_sections(): Known issue (cmark-gfm function pointer)" >> $GITHUB_STEP_SUMMARY
          echo "- read_markdown_blocks(): Known issue (cmark-gfm function pointer)" >> $GITHUB_STEP_SUMMARY
